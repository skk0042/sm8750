name: 清理 (Workflow+CCache)
on:
  workflow_dispatch:
    inputs:
      clean_mode:
        description: "Workflow清理模式（amount=保留数量，date=保留天数）"
        required: true
        type: choice
        default: 'amount'
        options:
          - 'amount'
          - 'date'
      clean_to_keep:
        description: "Workflow保留数量/天数（amount填数字，date填天数，如3）"
        required: true
        type: string
        default: "3"
      confirm_ccache_delete:
        description: "输入DELETE确认清理所有ccache缓存（不清理则留空）"
        required: false
        type: string
        default: ""

jobs:
  unified-clean:
    runs-on: ubuntu-latest
    permissions:
      actions: write  # 用于删除Workflow和缓存
      contents: read  # 用于检出仓库
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO_FULL_NAME: ${{ github.repository }}
      CCACHE_KEY_PREFIX: "ccache-neov2-"

    steps:
      - name: 检出仓库（获取GH CLI配置）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装并配置GitHub CLI
        run: |
          # 安装依赖
          sudo apt-mark hold firefox libc-bin
          sudo apt purge man-db
          sudo apt update && sudo apt install -y jq gh
          # 授权GH CLI
          gh auth login --with-token <<< "$GH_TOKEN"
          gh --version
          echo "GH CLI配置完成"

      - name: 验证CCache清理确认（防止误操作）
        if: ${{ github.event.inputs.confirm_ccache_delete != '' }}
        run: |
          if [[ "${{ github.event.inputs.confirm_ccache_delete }}" != "DELETE" ]]; then
            echo "::error::必须输入DELETE才能清理ccache缓存！"
            exit 1
          fi
          echo "CCache清理确认通过"

           # -------------------------- 清理Workflow运行记录 --------------------------
      - name: 按「保留数量」清理Workflow
        if: ${{ github.event.inputs.clean_mode == 'amount' }}
        run: |
          echo "=== 按保留数量清理Workflow（保留最近 ${{ github.event.inputs.clean_to_keep }} 个） ==="
          # 获取所有Workflow（排除当前运行ID，按创建时间倒序）
          all_runs=$(gh api -X GET "repos/$REPO_FULL_NAME/actions/runs?per_page=100" |
            jq --arg current_run "${{ github.run_id }}" '.workflow_runs | map(select(.id != ($current_run | tonumber)))')
          
          # 计算清理数量
          total_runs=$(echo "$all_runs" | jq length)
          keep_count=$(( ${{ github.event.inputs.clean_to_keep }} < total_runs ? ${{ github.event.inputs.clean_to_keep }} : total_runs ))
          echo "当前共有 $total_runs 个Workflow运行记录，保留最近 $keep_count 个"
          
          # 获取需保留的Run ID
          keep_ids=$(echo "$all_runs" | jq -r "sort_by(.created_at) | reverse | .[0:$keep_count] | .[].id")
          
          # 删除非保留的Run（跳过运行中/排队的）
          echo "$all_runs" | jq -r '.[] | select(.status != "in_progress" and .status != "queued") | .id' | while read run_id; do
            if ! grep -qw "$run_id" <<< "$keep_ids"; then
              echo "删除Workflow Run: $run_id"
              gh api -X DELETE "repos/$REPO_FULL_NAME/actions/runs/$run_id" --silent
            fi
          done
          echo "Workflow按数量清理完成"

      - name: 按「保留天数」清理Workflow
        if: ${{ github.event.inputs.clean_mode == 'date' }}
        run: |
          echo "=== 按保留天数清理Workflow（保留 ${{ github.event.inputs.clean_to_keep }} 天内的） ==="
          # 计算截止时间（UTC格式）
          cutoff_date=$(date -d "${{ github.event.inputs.clean_to_keep }} days ago" -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "删除 $cutoff_date 之前的所有Workflow运行记录"
          
          # 获取需删除的Run ID（排除当前运行、运行中/排队的）
          to_delete_ids=$(gh api -X GET "repos/$REPO_FULL_NAME/actions/runs?created=<$cutoff_date&per_page=100" |
            jq -r --arg current_run "${{ github.run_id }}" '.workflow_runs[] | 
            select(.id != ($current_run | tonumber) and .status != "in_progress" and .status != "queued") | .id')
          
          # 批量删除
          for run_id in $to_delete_ids; do
            echo "删除Workflow Run: $run_id（创建于 $cutoff_date 之前）"
            gh api -X DELETE "repos/$REPO_FULL_NAME/actions/runs/$run_id" --silent
          done
          echo "Workflow按天数清理完成"

      # -------------------------- 清理CCache缓存 --------------------------
      - name: 清理CCache缓存（匹配内核构建的缓存前缀）
        if: ${{ github.event.inputs.confirm_ccache_delete == 'DELETE' }}
        run: |
          echo "=== 清理CCache缓存（匹配前缀：$CCACHE_KEY_PREFIX） ==="
          # 获取所有匹配的缓存ID
          cache_ids=$(gh api -X GET "repos/$REPO_FULL_NAME/actions/caches?per_page=100" |
            jq -r --arg prefix "$CCACHE_KEY_PREFIX" '.actions_caches[] | select(.key | startswith($prefix)) | .id')
          
          if [[ -z "$cache_ids" ]]; then
            echo "未找到匹配的CCache缓存，无需清理"
            exit 0
          fi
          
          # 批量删除缓存
          total_deleted=0
          for cache_id in $cache_ids; do
            echo "删除CCache缓存 ID: $cache_id"
            gh api -X DELETE "repos/$REPO_FULL_NAME/actions/caches/$cache_id" --silent
            ((total_deleted++))
          done
          
          echo "CCache缓存清理完成，共删除 $total_deleted 个缓存"

      - name: 清理本地冗余文件（可选）
        run: |
          echo "=== 清理本地冗余文件 ==="
          # 清理系统临时文件
          sudo rm -rf /tmp/* /var/log/*
          # 清理APT缓存
          sudo apt clean
          # 查看清理后空间
          echo "清理后磁盘空间："
          df -h
