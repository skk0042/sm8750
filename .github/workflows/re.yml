name: 批量构建 ReSukiSU 内核 (全平台)

on:
  workflow_dispatch:
    inputs:
      batch_devices:
        description: '批量构建的处理器型号（英文逗号分隔，例：oneplus_sm8750,oneplus_sm8650,oneplus_mt6991,oneplus_mt6989）'
        required: true
        default: 'oneplus_sm8750,oneplus_sm8650,oneplus_mt6991,oneplus_mt6989'
      lz4_enable:
        description: '是否安装 lz4 1.10.0+zstd 1.5.7 补丁'
        required: true
        type: boolean
        default: true
      bbr_enable:
        description: '是否启用bbr算法 (false/true/default)'
        required: true
        type: choice
        default: 'false'
        options: ['false','true','default']
      ssg_enable:
        description: '是否启用三星SSG IO调度器 (仅6.1内核有效)'
        required: true
        type: boolean
        default: true
      adios_enable:
        description: '是否启用ADIOS IO调度器 (仅6.6内核有效)'
        required: true
        type: boolean
        default: true
      kernel_suffix:
        description: '内核后缀 (留空默认，勿加连字符)'
        required: false
        type: string
        default: ''
      custom_kernel_time:
        description: '自定义构建时间 (仅在取消勾选“保持原设置”时有效)'
        required: false
        default: ''
        type: string
      keep_original_settings:
        description: '保持原内核名称及构建时间'
        required: false
        default: true
        type: boolean
      

env:
  TZ: Asia/Shanghai

jobs:
  batch_build:
    name: Build_${{ matrix.DEVICE }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        DEVICE:
          - oneplus_sm8750
          - oneplus_sm8650
          - oneplus_mt6991
          - oneplus_mt6989
    if: contains(format(',{0},', github.event.inputs.batch_devices), format(',{0},', matrix.DEVICE))

    env:
      DEVICES_NAME: ${{ matrix.DEVICE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 处理器型号配置
        run: |
          case "${{ env.DEVICES_NAME }}" in
            oneplus_sm8750)
              echo "CHIPSET=sm8750" >> $GITHUB_ENV
              echo "ANDROID_VERSION=android15" >> $GITHUB_ENV
              echo "KERNEL_VERSION=6.6" >> $GITHUB_ENV
              ;;
            oneplus_sm8650)
              echo "CHIPSET=sm8650" >> $GITHUB_ENV
              echo "ANDROID_VERSION=android14" >> $GITHUB_ENV
              echo "KERNEL_VERSION=6.1" >> $GITHUB_ENV
              ;;
            oneplus_mt6991)
              echo "CHIPSET=mt6991" >> $GITHUB_ENV
              echo "ANDROID_VERSION=android15" >> $GITHUB_ENV
              echo "KERNEL_VERSION=6.6" >> $GITHUB_ENV
              ;;
            oneplus_mt6989)
              echo "CHIPSET=mt6989" >> $GITHUB_ENV
              echo "ANDROID_VERSION=android14" >> $GITHUB_ENV
              echo "KERNEL_VERSION=6.1" >> $GITHUB_ENV
              ;;
          esac

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache aria2 dos2unix p7zip-full

      - name: 克隆内核源码
        run: |
          rm -rf kernel_workspace
          mkdir kernel_workspace
          cd kernel_workspace
          case "${{ env.CHIPSET }}" in
            sm8750)
              URL="https://github.com/cctv18/android_kernel_common_oneplus_sm8750/archive/refs/heads/oneplus/sm8750_v_16.0.0_oneplus_13_6.6.89.zip"
              UNZIP_DIR="android_kernel_common_oneplus_sm8750-oneplus-sm8750_v_16.0.0_oneplus_13_6.6.89"
              ;;
            sm8650)
              URL="https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_b_16.0.0_oneplus12.zip"
              UNZIP_DIR="android_kernel_common_oneplus_sm8650-oneplus-sm8650_b_16.0.0_oneplus12"
              ;;
            mt6991)
              URL="https://github.com/cctv18/android_kernel_oneplus_mt6991/archive/refs/heads/oneplus/mt6991_v_15.0.2_ace5_ultra_6.6.89.zip"
              UNZIP_DIR="android_kernel_oneplus_mt6991-oneplus-mt6991_v_15.0.2_ace5_ultra_6.6.89"
              ;;
            mt6989)
              URL="https://github.com/cctv18/android_kernel_oneplus_mt6989/archive/refs/heads/oneplus/mt6989_v_15.0.2_ace5_race.zip"
              UNZIP_DIR="android_kernel_oneplus_mt6989-oneplus-mt6989_v_15.0.2_ace5_race"
              ;;
          esac
          aria2c -s16 -x16 -k1M "$URL" -o common.zip
          unzip -q common.zip && mv "$UNZIP_DIR" common && rm -f common.zip

      - name: 克隆工具链
        run: |
          cd kernel_workspace
          if [[ "${{ env.KERNEL_VERSION }}" == "6.1" ]]; then
            CLANG_URL="https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip"
          else
            CLANG_URL="https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/clang-r510928.zip"
          fi
          mkdir -p clang
          aria2c -s16 -x16 -k1M "$CLANG_URL" -o clang.zip
          unzip -q clang.zip -d clang && rm -f clang.zip
          aria2c -s16 -x16 -k1M "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/build-tools.zip" -o build-tools.zip
          unzip -q build-tools.zip && rm -f build-tools.zip

      - name: 去除 ABI 保护和 dirty 后缀
        run: |
          cd kernel_workspace
          rm -f common/android/abi_gki_protected_exports_* || true
          for f in common/scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
          done

      - name: 配置 ReSukiSU
        id: ksu_version
        run: |
          cd kernel_workspace
          echo "正在配置ReSukiSU..."
          curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/refs/heads/main/kernel/setup.sh" | bash -s main
          echo 'CONFIG_KSU_FULL_NAME_FORMAT="%TAG_NAME%-%COMMIT_SHA%-TG:@SKK0042NB"' >> ./common/arch/arm64/configs/gki_defconfig
          cd ./KernelSU
          KSU_VERSION=$(expr $(git rev-list --count main) + 30700 2>/dev/null || echo 114514)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT

      - name: 应用 SUSFS 补丁
        run: |
          cd kernel_workspace
          git clone --depth=1 https://github.com/cctv18/susfs4oki.git susfs4ksu -b oki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          wget https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/refs/heads/main/other_patch/69_hide_stuff.patch -O ./common/69_hide_stuff.patch
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
          cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          cd ./common
          patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          patch -p1 -N -F 3 < 69_hide_stuff.patch || true

      - name: 应用 lz4 1.10.0 & zstd 1.5.7 补丁
        run: |
          cd kernel_workspace
          if [[ "${{ env.CHIPSET }}" == sm8750 || "${{ env.CHIPSET }}" == mt6991 ]]; then
            git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8750.git patch_repo
          else
            git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8650.git patch_repo
          fi
          cp ./patch_repo/zram_patch/001-lz4.patch ./common/
          cp ./patch_repo/zram_patch/lz4armv8.S ./common/lib/
          cp ./patch_repo/zram_patch/002-zstd.patch ./common/
          cd ./common
          git apply -p1 < 001-lz4.patch || true
          patch -p1 < 002-zstd.patch || true
          if [[ "${{ env.CHIPSET }}" == mt6991 ]]; then
            cp ../patch_repo/zram_patch/001-lz4-clearMake.patch ./
            git apply -p1 < 001-lz4-clearMake.patch || true
          fi
          rm -rf ../patch_repo

      - name: 应用 lz4kd 补丁
        if: github.event.inputs.lz4kd_enable == 'true'
        run: |
          cd kernel_workspace
          git clone --depth=1 https://github.com/ShirkNeko/SukiSU_patch.git
          cd common
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./lib
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto
          cp ../SukiSU_patch/other/zram/zram_patch/${{ env.KERNEL_VERSION }}/lz4kd.patch ./
          patch -p1 -F 3 < lz4kd.patch || true

      - name: 添加内核配置
        run: |
          cd kernel_workspace
          DEFCONFIG=./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          if [[ "${{ github.event.inputs.kpm_enable }}" == "builtin" ]]; then
            echo "CONFIG_KPM=y" >> $DEFCONFIG
          fi
            echo "CONFIG_KSU_SUSFS=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> $DEFCONFIG
            echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> $DEFCONFIG
          echo "CONFIG_TMPFS_XATTR=y" >> $DEFCONFIG
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $DEFCONFIG
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> $DEFCONFIG
          echo "CONFIG_HEADERS_INSTALL=n" >> $DEFCONFIG
          sed -i 's/check_defconfig//' ./common/build.config.gki

      - name: 启用网络功能增强
        run: |
          cd kernel_workspace
          DEFCONFIG=./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_BPF_STREAM_PARSER=y" >> $DEFCONFIG
          echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> $DEFCONFIG
          echo "CONFIG_NETFILTER_XT_SET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_MAX=65534" >> $DEFCONFIG
          echo "CONFIG_IP_SET_BITMAP_IP=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_BITMAP_PORT=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IP=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPMARK=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPPORT=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPMAC=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_MAC=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NETNET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NETPORT=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_LIST_SET=y" >> $DEFCONFIG
          echo "CONFIG_IP6_NF_NAT=y" >> $DEFCONFIG
          echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> $DEFCONFIG
          cd common
          if [[ "${{ env.CHIPSET }}" == sm8750 || "${{ env.CHIPSET }}" == mt6991 ]]; then
            wget -q https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/other_patch/config.patch
          else
            wget -q https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/refs/heads/main/other_patch/config.patch
          fi
          patch -p1 -F 3 < config.patch || true

      - name: 添加 BBR 拥塞控制算法
        run: |
          cd kernel_workspace
          DEFCONFIG=./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_BBR=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_CUBIC=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_VEGAS=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_NV=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_WESTWOOD=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_HTCP=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_BRUTAL=y" >> $DEFCONFIG
          if [[ "${{ github.event.inputs.bbr_enable }}" == "default" ]]; then
            echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> $DEFCONFIG
          else
            echo "CONFIG_DEFAULT_TCP_CONG=cubic" >> $DEFCONFIG
          fi

      - name: 启用 IO 调度器
        run: |
          cd kernel_workspace
          DEFCONFIG=./common/arch/arm64/configs/gki_defconfig
          if [[ "${{ env.KERNEL_VERSION }}" == "6.1" && "${{ github.event.inputs.ssg_enable }}" == "true" ]]; then
            echo "CONFIG_MQ_IOSCHED_SSG=y" >> $DEFCONFIG
            echo "CONFIG_MQ_IOSCHED_SSG_CGROUP=y" >> $DEFCONFIG
          fi
          if [[ "${{ env.KERNEL_VERSION }}" == "6.6" && "${{ github.event.inputs.adios_enable }}" == "true" ]]; then
            echo "CONFIG_MQ_IOSCHED_ADIOS=y" >> $DEFCONFIG
            echo "CONFIG_MQ_IOSCHED_DEFAULT_ADIOS=y" >> $DEFCONFIG
          fi


      - name: 设置内核版本后缀
        run: |
          cd kernel_workspace
          if [[ "${{ github.event.inputs.keep_original_settings }}" == "true" && -z "${{ github.event.inputs.kernel_suffix }}" ]]; then
            case "${{ env.CHIPSET }}" in
              sm8750|mt6991) SUFFIX="-android15-8-g29d86c5fc9dd-abogki428889875-4k" ;;
              sm8650|mt6989) SUFFIX="-android14-g-gca13bffobf09" ;;
            esac
          else
            SUFFIX="${{ github.event.inputs.kernel_suffix }}"
          fi
          ESCAPED_SUFFIX=$(printf '%s\n' "$SUFFIX" | sed 's:[\/&]:\\&:g')
          sudo sed -i "s/-4k/$ESCAPED_SUFFIX/g" ./common/arch/arm64/configs/gki_defconfig
          sed -i 's/${scm_version}//' ./common/scripts/setlocalversion
          echo "CONFIG_LOCALVERSION_AUTO=n" >> ./common/arch/arm64/configs/gki_defconfig

      - name: 准备时间劫持
        run: |
          cd kernel_workspace/common
          wget -q https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/lib/libfakestat.so
          wget -q https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/lib/libfaketimeMT.so
          chmod 777 ./*.so
          export FAKESTAT="2025-05-25 12:00:00"
          export FAKETIME="@2025-05-25 13:00:00"
          echo "FAKESTAT=$FAKESTAT" >> $GITHUB_ENV
          echo "FAKETIME=$FAKETIME" >> $GITHUB_ENV
          SO_DIR=$(pwd)
          export PRELOAD_LIBS="$SO_DIR/libfakestat.so $SO_DIR/libfaketimeMT.so"
          # 创建包装器
          echo '#!/bin/bash' > cc-wrapper
          echo 'export LD_PRELOAD="'$PRELOAD_LIBS'"' >> cc-wrapper
          echo 'export FAKESTAT="'$FAKESTAT'"' >> cc-wrapper
          echo 'export FAKETIME="'$FAKETIME'"' >> cc-wrapper
          echo 'ccache clang "$@"' >> cc-wrapper
          echo '#!/bin/bash' > ld-wrapper
          echo 'export LD_PRELOAD="'$PRELOAD_LIBS'"' >> ld-wrapper
          echo 'export FAKESTAT="'$FAKESTAT'"' >> ld-wrapper
          echo 'export FAKETIME="'$FAKETIME'"' >> ld-wrapper
          echo 'ld.lld "$@"' >> ld-wrapper
          chmod +x cc-wrapper ld-wrapper
          echo '#!/bin/bash' > test-wrapper.sh
          echo 'export LD_PRELOAD="'$PRELOAD_LIBS'"' >> test-wrapper.sh
          echo 'export FAKESTAT="'$FAKESTAT'"' >> test-wrapper.sh
          echo 'export FAKETIME="'$FAKETIME'"' >> test-wrapper.sh
          echo 'exec "$@"' >> test-wrapper.sh
          chmod +x test-wrapper.sh
          ./test-wrapper.sh date
          ./test-wrapper.sh stat ./Makefile

      - name: 编译内核
        run: |
          WORKDIR="$(pwd)"
          export PATH="/usr/lib/ccache:$WORKDIR/kernel_workspace/clang/bin:$WORKDIR/kernel_workspace/build-tools/bin:$PATH"
          export CCACHE_LOGFILE="${{ github.workspace }}/kernel_workspace/ccache.log"
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="$HOME/.ccache_${{ env.CHIPSET }}"
          export CCACHE_MAXSIZE="8G"
          mkdir -p "$CCACHE_DIR"
          echo "sloppiness = file_stat_matches,include_file_ctime,include_file_mtime,pch_defines,file_macro,time_macros" >> "$CCACHE_DIR/ccache.conf"
          cd kernel_workspace/common
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL &
          make -j$(nproc) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" LD="ld.lld" HOSTLD=ld.lld O=out KCFLAGS+=-O2 KCFLAGS+=-Wno-error gki_defconfig
          export KBUILD_BUILD_TIMESTAMP="${{ github.event.inputs.custom_kernel_time }}"
          make -j$(nproc) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="$(pwd)/cc-wrapper" LD="$(pwd)/ld-wrapper" HOSTLD=ld.lld O=out KCFLAGS+=-O2 KCFLAGS+=-Wno-error Image

      - name: 制作 Anykernel3
        run: |
          git clone https://github.com/skk0042/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          mkdir -p kernel_workspace/out/Final-Image-Find/
          
          image_path=$(find "./kernel_workspace/common/out/" -type f -name "Image" -print -quit)
          if [ -z "$image_path" ]; then
            echo "❌ 未找到Image文件，构建失败"
            ls -la ./kernel_workspace/common/out/
            exit 1
          fi
          
          cp "$image_path" ./AnyKernel3/Image
          cp "$image_path" kernel_workspace/out/Final-Image-Find/Image
          
          if [[ "${{ env.CHIPSET }}" == "sm8750" ]]; then
            dir2=$(dirname "$image_path")/
            for file in dtbo.img system_dlkm.erofs.img; do
              if [ -f "$dir2$file" ]; then
                target_name="$file"
                [[ $file == "system_dlkm.erofs.img" ]] && target_name="system_dlkm.img"
                cp "$dir2$file" "./AnyKernel3/$target_name"
              fi
            done
          fi
        if: contains(format(',{0},', github.event.inputs.batch_devices), format(',{0},', matrix.DEVICE))
        
      - name: 上传 Anykernel3
        uses: actions/upload-artifact@v4
        with:
          name: ReSukiSU_${{ env.KSUVER }}_${{ env.CHIPSET }}
          path: ./AnyKernel3/*